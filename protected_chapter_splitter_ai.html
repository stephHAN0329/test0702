<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å—ä¿æŠ¤çš„AIå¢å¼ºç‰ˆå°è¯´ç« èŠ‚æ‹†åˆ†å·¥å…·</title>
    <style>
        /* å¯†ç è¾“å…¥æ ·å¼ */
        body {
            font-family: 'Microsoft YaHei', 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .center-box {
            max-width: 400px;
            margin: 100px auto 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px 30px 30px 30px;
            text-align: center;
        }
        .center-box h2 {
            margin-bottom: 20px;
            color: #4facfe;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
        }
        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 1em;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
    </style>
    <!-- ä¸‹é¢æ˜¯åŸå·¥å…·é¡µé¢çš„å…¨éƒ¨æ ·å¼ -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 300;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .content {
            padding: 40px;
        }

        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab.active {
            border-bottom-color: #4facfe;
            color: #4facfe;
        }

        .tab:hover {
            background-color: #f8f9ff;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .upload-section {
            border: 3px dashed #e0e0e0;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-section:hover {
            border-color: #4facfe;
            background-color: #f8f9ff;
        }

        .upload-section.dragover {
            border-color: #4facfe;
            background-color: #f0f8ff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 3em;
            color: #4facfe;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 1.2em;
            color: #666;
            margin-bottom: 15px;
        }

        .upload-hint {
            font-size: 0.9em;
            color: #999;
        }

        #fileInput {
            display: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #4facfe;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
        }

        .btn {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            box-shadow: 0 4px 15px rgba(79, 172, 254, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }

        .btn-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .chapters-preview {
            margin-top: 30px;
            display: none;
        }

        .chapters-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-top: 15px;
        }

        .chapter-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chapter-item:last-child {
            border-bottom: none;
        }

        .chapter-item:hover {
            background-color: #f8f9ff;
        }

        .chapter-title {
            font-weight: 500;
            color: #333;
        }

        .chapter-line {
            color: #666;
            font-size: 0.9em;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            text-align: left;
            font-weight: 500;
            white-space: pre-line;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status.warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .progress {
            width: 100%;
            height: 6px;
            background-color: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-top: 15px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            width: 0%;
            transition: width 0.3s ease;
        }

        .file-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #4facfe;
        }

        .file-info h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .file-info p {
            color: #666;
            margin: 5px 0;
        }

        .download-section {
            margin-top: 30px;
            text-align: center;
            display: none;
        }

        .download-btn {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(86, 171, 47, 0.3);
        }

        .download-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(86, 171, 47, 0.4);
        }

        .ai-results {
            margin-top: 30px;
            display: none;
        }

        .ai-result-item {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            background: #fafafa;
        }

        .ai-result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }

        .ai-result-title {
            font-weight: 600;
            color: #333;
        }

        .ai-result-status {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 500;
        }

        .ai-result-status.success {
            background: #d4edda;
            color: #155724;
        }

        .ai-result-status.warning {
            background: #fff3cd;
            color: #856404;
        }

        .ai-result-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .ai-result-content {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            background: white;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #e0e0e0;
            max-height: 300px;
            overflow-y: auto;
        }

        /* å·®å¼‚å¯¹æ¯”æ ·å¼ */
        .differences-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e0e0e0;
        }

        .differences-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .differences-header h4 {
            color: #333;
            margin: 0;
        }

        .selection-buttons {
            display: flex;
            gap: 10px;
        }

        .btn-sm {
            padding: 8px 16px;
            font-size: 0.9em;
        }

        .differences-list {
            margin-bottom: 20px;
        }

        .difference-item {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .difference-line {
            font-weight: 600;
            color: #495057;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .difference-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        .first-version, .second-version {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
        }

        .version-label {
            display: block;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
            font-size: 0.9em;
        }

        .first-version .version-label {
            color: #007bff;
        }

        .second-version .version-label {
            color: #6c757d;
        }

        .difference-content pre {
            margin: 0;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            color: #333;
        }

        .full-results {
            margin-top: 20px;
        }

        .full-results summary {
            cursor: pointer;
            font-weight: 600;
            color: #007bff;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .full-results-content {
            margin-top: 15px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .result-version {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 15px;
        }

        .result-version h5 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1em;
        }

        .result-version pre {
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            margin: 0;
        }

        .no-differences {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 6px;
            padding: 15px;
            color: #155724;
        }

        .no-differences p {
            margin: 0 0 10px 0;
            font-weight: 600;
        }

        .error-content {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 6px;
            padding: 15px;
            color: #721c24;
        }

        .error-content p {
            margin: 0 0 10px 0;
            font-weight: 600;
        }

        .error-content pre {
            background: white;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 150px;
            overflow-y: auto;
        }

        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 0.9em;
            border-top: 1px solid #e0e0e0;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        .diagnostic-info {
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .diagnostic-item {
            margin: 5px 0;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .diagnostic-item:last-child {
            border-bottom: none;
        }

        .diagnostic-success {
            color: #28a745;
        }

        .diagnostic-error {
            color: #dc3545;
        }

        .diagnostic-warning {
            color: #ffc107;
        }

        .merge-section {
            margin-top: 30px;
            display: none;
        }

        .merge-preview {
            background-color: #f8f9fa;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 10px;
            }
            
            .content {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }

            .tabs {
                flex-direction: column;
            }

            .tab {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div id="authBox" class="center-box">
        <h2>ğŸ”’ è¯·è¾“å…¥ä»Šæ—¥åŠ¨æ€å¯†ç </h2>
        <div class="form-group">
            <input type="password" id="passwordInput" placeholder="è¾“å…¥ä»Šæ—¥å¯†ç " autocomplete="off" />
        </div>
        <button class="btn" onclick="checkPassword()">è¿›å…¥å·¥å…·</button>
        <div id="status" class="status" style="display:none;"></div>
        <div style="margin-top:18px;color:#888;font-size:0.95em;">å¦‚éœ€å¯†ç è¯·è”ç³»ç®¡ç†å‘˜æˆ–ä½¿ç”¨å¯†ç ç”Ÿæˆå™¨</div>
    </div>
    <div id="mainApp" style="display:none;">
        <div class="container">
            <div class="header">
                <h1>ğŸ¤– AIå¢å¼ºç‰ˆå°è¯´ç« èŠ‚æ‹†åˆ†å·¥å…·</h1>
                <p>æ™ºèƒ½æ‹†åˆ†ç« èŠ‚ + å¤§æ¨¡å‹æ‰¹é‡å¤„ç†</p>
            </div>

            <div class="content">
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('split')">ğŸ“š ç« èŠ‚æ‹†åˆ†</div>
                    <div class="tab" onclick="switchTab('ai')">ğŸ¤– AIé…ç½®</div>
                    <div class="tab" onclick="switchTab('process')">âš¡ æ‰¹é‡å¤„ç†</div>
                    <div class="tab" onclick="switchTab('results')">ğŸ“Š å¤„ç†ç»“æœ</div>
                </div>

                <!-- ç« èŠ‚æ‹†åˆ†æ ‡ç­¾é¡µ -->
                <div id="split-tab" class="tab-content active">
                    <div class="form-group">
                        <label for="formatType">æ–‡æ¡£æ ¼å¼ï¼š</label>
                        <select id="formatType">
                            <option value="markdown">Markdownæ ¼å¼ï¼ˆ##æ­£æ–‡ + ###ç¬¬Xç« ï¼‰</option>
                            <option value="standard">æ ‡å‡†æ ¼å¼ï¼ˆç¬¬Xç«  æ ‡é¢˜ï¼‰</option>
                        </select>
                    </div>

                    <div class="upload-section" id="uploadSection">
                        <div class="upload-icon">ğŸ“</div>
                        <div class="upload-text">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶æˆ–æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„</div>
                        <div class="upload-hint" id="uploadHint">æ”¯æŒ .txt æ–‡ä»¶ï¼Œç« èŠ‚æ ¼å¼ï¼šç¬¬Xç«  æ ‡é¢˜</div>
                        <input type="file" id="fileInput" accept=".txt" />
                    </div>

                    <div class="file-info" id="fileInfo" style="display: none;">
                        <h4>ğŸ“„ æ–‡ä»¶ä¿¡æ¯</h4>
                        <p id="fileName"></p>
                        <p id="fileSize"></p>
                        <p id="fileEncoding"></p>
                    </div>

                    <div class="chapters-preview" id="chaptersPreview">
                        <h3>ğŸ“– æ£€æµ‹åˆ°çš„ç« èŠ‚</h3>
                        <div class="chapters-list" id="chaptersList"></div>
                        <button class="btn btn-success" id="splitBtn">âœ‚ï¸ å¼€å§‹æ‹†åˆ†</button>
                    </div>

                    <div class="status" id="status" style="display: none;"></div>
                    <div class="progress" id="progress" style="display: none;">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>

                    <div class="download-section" id="downloadSection">
                        <h3>ğŸ‰ æ‹†åˆ†å®Œæˆï¼</h3>
                        <p>å…±ç”Ÿæˆ <span id="chapterCount">0</span> ä¸ªç« èŠ‚æ–‡ä»¶</p>
                        <button class="btn download-btn" id="downloadAllBtn">ğŸ“¥ ä¸‹è½½æ‰€æœ‰ç« èŠ‚</button>
                        <button class="btn btn-secondary" id="mergeChapters">ğŸ”— åˆå¹¶ç« èŠ‚</button>
                        <button class="btn btn-warning" id="processWithAI">ğŸ¤– ä½¿ç”¨AIå¤„ç†ç« èŠ‚</button>
                    </div>
                </div>

                <!-- AIé…ç½®æ ‡ç­¾é¡µ -->
                <div id="ai-tab" class="tab-content">
                    <h3>ğŸ¤– AIæ¨¡å‹é…ç½®</h3>
                    
                    <div class="form-group">
                        <label for="aiProvider">é€‰æ‹©AIæä¾›å•†ï¼š</label>
                        <select id="aiProvider">
                            <option value="openai">OpenAI (GPT-3.5/4)</option>
                            <option value="anthropic">Anthropic (Claude)</option>
                            <option value="doubao">è±†åŒ…æ¨¡å‹ (DouBao)</option>
                            <option value="google">Google (Gemini)</option>
                            <option value="custom">è‡ªå®šä¹‰API</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="apiKey">APIå¯†é’¥ï¼š</label>
                        <input type="password" id="apiKey" placeholder="è¯·è¾“å…¥æ‚¨çš„APIå¯†é’¥" />
                    </div>

                    <div class="form-group">
                        <label for="apiEndpoint">APIç«¯ç‚¹ï¼ˆå¯é€‰ï¼‰ï¼š</label>
                        <input type="text" id="apiEndpoint" placeholder="https://api.openai.com/v1/chat/completions" />
                    </div>

                    <div class="form-group">
                        <label for="modelName">æ¨¡å‹åç§°ï¼š</label>
                        <input type="text" id="modelName" placeholder="gpt-3.5-turbo" />
                    </div>

                    <div class="form-group">
                        <label for="systemPrompt">ç³»ç»Ÿæç¤ºè¯ï¼š</label>
                        <textarea id="systemPrompt" placeholder="è¯·è¾“å…¥ç³»ç»Ÿæç¤ºè¯ï¼Œç”¨äºæŒ‡å¯¼AIå¦‚ä½•å¤„ç†æ¯ä¸ªç« èŠ‚å†…å®¹..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="maxTokens">æœ€å¤§Tokenæ•°ï¼š</label>
                        <input type="number" id="maxTokens" value="2000" min="100" max="8000" />
                    </div>

                    <div class="form-group">
                        <label for="temperature">æ¸©åº¦ï¼ˆåˆ›é€ æ€§ï¼‰ï¼š</label>
                        <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7" />
                        <span id="temperatureValue">0.7</span>
                    </div>

                    <button class="btn" onclick="testAIConnection()">ğŸ”— æµ‹è¯•AIè¿æ¥</button>
                    <button class="btn btn-secondary" onclick="saveAIConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                    <button class="btn btn-warning" onclick="diagnoseConnection()">ğŸ”§ è¿æ¥è¯Šæ–­</button>

                    <div class="status" id="aiStatus" style="display: none;"></div>
                    <div id="diagnosticInfo" style="display: none;"></div>
                </div>

                <!-- æ‰¹é‡å¤„ç†æ ‡ç­¾é¡µ -->
                <div id="process-tab" class="tab-content">
                    <h3>âš¡ æ‰¹é‡AIå¤„ç†</h3>
                    
                    <div class="form-group">
                        <label>å¤„ç†é€‰é¡¹ï¼š</label>
                        <div class="checkbox-group">
                            <input type="checkbox" id="processAll" checked />
                            <label for="processAll">å¤„ç†æ‰€æœ‰ç« èŠ‚</label>
                        </div>
                        <div class="checkbox-group">
                            <input type="checkbox" id="processSelected" />
                            <label for="processSelected">ä»…å¤„ç†é€‰ä¸­çš„ç« èŠ‚</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="batchSize">æ‰¹å¤„ç†å¤§å°ï¼š</label>
                        <input type="number" id="batchSize" value="3" min="1" max="10" />
                        <small>åŒæ—¶å¤„ç†çš„ç« èŠ‚æ•°é‡ï¼Œå»ºè®®3-5ä¸ª</small>
                    </div>

                    <div class="form-group">
                        <label for="delayBetweenBatches">æ‰¹æ¬¡é—´éš”ï¼ˆç§’ï¼‰ï¼š</label>
                        <input type="number" id="delayBetweenBatches" value="2" min="1" max="10" />
                        <small>é¿å…APIé™åˆ¶</small>
                    </div>

                    <div id="selectedChapters" style="display: none;">
                        <h4>é€‰ä¸­çš„ç« èŠ‚ï¼š</h4>
                        <div id="selectedChaptersList"></div>
                    </div>

                    <button class="btn btn-warning" id="startProcessing" onclick="startBatchProcessing()">ğŸš€ å¼€å§‹æ‰¹é‡å¤„ç†</button>
                    <button class="btn" id="stopProcessing" onclick="stopBatchProcessing()" style="display: none;">â¹ï¸ åœæ­¢å¤„ç†</button>

                    <div class="progress" id="processingProgress" style="display: none;">
                        <div class="progress-bar" id="processingProgressBar"></div>
                    </div>

                    <div class="status" id="processingStatus" style="display: none;"></div>
                </div>

                <!-- å¤„ç†ç»“æœæ ‡ç­¾é¡µ -->
                <div id="results-tab" class="tab-content">
                    <h3>ğŸ“Š AIåŒå¤„ç†ç»“æœ</h3>
                    
                    <div class="ai-results" id="aiResults">
                        <div id="aiResultsList"></div>
                    </div>

                    <button class="btn btn-success" id="downloadResults" onclick="downloadAllResults()" style="display: none;">ğŸ“¥ ä¸‹è½½æ‰€æœ‰ç»“æœ</button>
                    <button class="btn" id="clearResults" onclick="clearResults()">ğŸ—‘ï¸ æ¸…ç©ºç»“æœ</button>
                    
                    <hr style="margin: 30px 0; border: none; border-top: 1px solid #e0e0e0;">
                    
                    <h3>ğŸ”— ç« èŠ‚åˆå¹¶</h3>
                    <p>å°†æ‹†åˆ†åçš„ç« èŠ‚æ–‡ä»¶é‡æ–°åˆå¹¶ä¸ºå®Œæ•´æ–‡æ¡£</p>
                    
                    <div class="upload-section" id="mergeUploadSection">
                        <div class="upload-icon">ğŸ“</div>
                        <div class="upload-text">é€‰æ‹©è¦åˆå¹¶çš„ç« èŠ‚æ–‡ä»¶</div>
                        <div class="upload-hint">æ”¯æŒå¤šé€‰ï¼ŒæŒ‰æ–‡ä»¶åæ’åºåˆå¹¶</div>
                        <input type="file" id="mergeFileInput" accept=".txt" multiple />
                    </div>

                    <div class="merge-section" id="mergeSection" style="display: none;">
                        <h4>ğŸ“‹ åˆå¹¶é¢„è§ˆ</h4>
                        <div class="merge-preview" id="mergePreview"></div>
                        <button class="btn btn-success" id="mergeBtn">ğŸ”— å¼€å§‹åˆå¹¶</button>
                    </div>

                    <div class="status" id="mergeStatus" style="display: none;"></div>
                </div>
            </div>

            <div class="footer">
                <p>AIå¢å¼ºç‰ˆç« èŠ‚æ‹†åˆ†å·¥å…· | æ”¯æŒå¤šç§å¤§æ¨¡å‹API | æ™ºèƒ½æ‰¹é‡å¤„ç†</p>
            </div>
        </div>
    </div>
    <script>
    // å¯†ç ç®—æ³•ä¸password_generator.htmlä¸€è‡´
    function generatePassword(date) {
        const salt = "ChapterSplitter2024";
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const weekDay = date.getDay();
        const dateStr = `${year}${month}${day}${weekDay}`;
        const seed = dateStr + salt;
        let hash = 0;
        for (let i = 0; i < seed.length; i++) {
            const char = seed.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
        }
        const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let password = '';
        const hashStr = Math.abs(hash).toString();
        let extendedHash = hashStr;
        while (extendedHash.length < 16) {
            extendedHash += hashStr;
        }
        for (let i = 0; i < 8; i++) {
            const twoDigits = extendedHash.substr(i * 2, 2);
            const index = parseInt(twoDigits) % chars.length;
            password += chars[index];
        }
        return password;
    }
    function checkPassword() {
        const input = document.getElementById('passwordInput').value.trim();
        const todayPwd = generatePassword(new Date());
        const status = document.getElementById('status');
        if (input === todayPwd) {
            status.textContent = 'å¯†ç æ­£ç¡®ï¼Œæ­£åœ¨è¿›å…¥...';
            status.className = 'status success';
            status.style.display = 'block';
            setTimeout(function(){
                document.getElementById('authBox').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
            }, 800);
        } else {
            status.textContent = 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•ï¼';
            status.className = 'status error';
            status.style.display = 'block';
        }
    }
    // å›è½¦å¿«æ·é”®
    document.getElementById('passwordInput').addEventListener('keydown', function(e){
        if(e.key === 'Enter') checkPassword();
    });
    </script>
    <!-- ä¸‹é¢æ˜¯åŸå·¥å…·é¡µé¢çš„å…¨éƒ¨è„šæœ¬ -->
    <script>
        class AIChapterSplitter {
            constructor() {
                this.chapters = [];
                this.fileContent = '';
                this.fileName = '';
                this.chapterFiles = [];
                this.mergeFiles = [];
                this.aiResults = [];
                this.isProcessing = false;
                this.currentBatch = 0;
                this.totalBatches = 0;
                this.firstRoundResults = [];
                this.secondRoundResults = [];
                this.setupEventListeners();
                this.loadAIConfig();
                this.updateFormatHint();
            }

            setupEventListeners() {
                const uploadSection = document.getElementById('uploadSection');
                const fileInput = document.getElementById('fileInput');
                const splitBtn = document.getElementById('splitBtn');
                const downloadAllBtn = document.getElementById('downloadAllBtn');
                const processWithAIBtn = document.getElementById('processWithAI');
                const mergeChaptersBtn = document.getElementById('mergeChapters');
                const temperatureSlider = document.getElementById('temperature');
                const aiProviderSelect = document.getElementById('aiProvider');
                const formatTypeSelect = document.getElementById('formatType');
                const mergeUploadSection = document.getElementById('mergeUploadSection');
                const mergeFileInput = document.getElementById('mergeFileInput');
                const mergeBtn = document.getElementById('mergeBtn');

                // æ–‡ä»¶é€‰æ‹©
                uploadSection.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', (e) => this.handleFileSelect(e));

                // æ‹–æ‹½ä¸Šä¼ 
                uploadSection.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadSection.classList.add('dragover');
                });

                uploadSection.addEventListener('dragleave', () => {
                    uploadSection.classList.remove('dragover');
                });

                uploadSection.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadSection.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        this.processFile(files[0]);
                    }
                });

                // æ‹†åˆ†æŒ‰é’®
                splitBtn.addEventListener('click', () => this.splitChapters());

                // ä¸‹è½½æŒ‰é’®
                downloadAllBtn.addEventListener('click', () => this.downloadAllChapters());

                // AIå¤„ç†æŒ‰é’®
                processWithAIBtn.addEventListener('click', () => {
                    switchTab('process');
                });

                // åˆå¹¶æŒ‰é’®
                mergeChaptersBtn.addEventListener('click', () => {
                    switchTab('results');
                });

                // æ ¼å¼é€‰æ‹©å™¨
                formatTypeSelect.addEventListener('change', () => {
                    this.updateFormatHint();
                });

                // åˆå¹¶æ–‡ä»¶é€‰æ‹©
                mergeUploadSection.addEventListener('click', () => mergeFileInput.click());
                mergeFileInput.addEventListener('change', (e) => this.handleMergeFileSelect(e));

                // åˆå¹¶æŒ‰é’®
                mergeBtn.addEventListener('click', () => this.mergeChapters());

                // æ¸©åº¦æ»‘å—
                temperatureSlider.addEventListener('input', (e) => {
                    document.getElementById('temperatureValue').textContent = e.target.value;
                });

                // AIæä¾›å•†é€‰æ‹©
                aiProviderSelect.addEventListener('change', () => {
                    this.updateProviderConfig();
                });
            }

            handleFileSelect(event) {
                const file = event.target.files[0];
                if (file) {
                    this.processFile(file);
                }
            }

            processFile(file) {
                if (!file.name.toLowerCase().endsWith('.txt')) {
                    this.showStatus('è¯·é€‰æ‹© .txt æ–‡ä»¶', 'error');
                    return;
                }

                this.fileName = file.name;
                this.showFileInfo(file);

                const reader = new FileReader();
                reader.onload = (e) => {
                    this.fileContent = e.target.result;
                    this.findChapters();
                };
                reader.onerror = () => {
                    this.showStatus('æ–‡ä»¶è¯»å–å¤±è´¥', 'error');
                };
                reader.readAsText(file, 'UTF-8');
            }

            showFileInfo(file) {
                const fileInfo = document.getElementById('fileInfo');
                const fileName = document.getElementById('fileName');
                const fileSize = document.getElementById('fileSize');

                fileName.textContent = `æ–‡ä»¶åï¼š${file.name}`;
                fileSize.textContent = `æ–‡ä»¶å¤§å°ï¼š${this.formatFileSize(file.size)}`;
                
                fileInfo.style.display = 'block';
            }

            formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            findChapters() {
                const formatType = document.getElementById('formatType').value;
                let chapterPattern;
                
                if (formatType === 'markdown') {
                    // æŸ¥æ‰¾ ###ç¬¬Xç«  æ ¼å¼çš„ç« èŠ‚
                    chapterPattern = /^###ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡\d]+ç« .*$/gm;
                } else {
                    // æŸ¥æ‰¾ ç¬¬Xç«  æ ¼å¼çš„ç« èŠ‚
                    chapterPattern = /^ç¬¬[ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡\d]+ç« .*$/gm;
                }
                
                const lines = this.fileContent.split('\n');
                this.chapters = [];

                lines.forEach((line, index) => {
                    if (chapterPattern.test(line.trim())) {
                        this.chapters.push({
                            index: index,
                            title: line.trim(),
                            lineNumber: index + 1
                        });
                    }
                });

                if (this.chapters.length === 0) {
                    const errorMessage = formatType === 'markdown' 
                        ? 'æœªæ‰¾åˆ°ä»»ä½•ç« èŠ‚ï¼è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚ç« èŠ‚æ ¼å¼åº”ä¸ºï¼š###ç¬¬Xç«  æ ‡é¢˜' 
                        : 'æœªæ‰¾åˆ°ä»»ä½•ç« èŠ‚ï¼è¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚ç« èŠ‚æ ¼å¼åº”ä¸ºï¼šç¬¬Xç«  æ ‡é¢˜';
                    this.showStatus(errorMessage, 'error');
                    return;
                }

                this.showChaptersPreview();
                this.showStatus(`æ‰¾åˆ° ${this.chapters.length} ä¸ªç« èŠ‚`, 'success');
            }

            showChaptersPreview() {
                const chaptersPreview = document.getElementById('chaptersPreview');
                const chaptersList = document.getElementById('chaptersList');

                chaptersList.innerHTML = '';
                this.chapters.forEach((chapter, index) => {
                    const chapterItem = document.createElement('div');
                    chapterItem.className = 'chapter-item';
                    chapterItem.innerHTML = `
                        <span class="chapter-title">${chapter.title}</span>
                        <span class="chapter-line">ç¬¬${chapter.lineNumber}è¡Œ</span>
                    `;
                    chaptersList.appendChild(chapterItem);
                });

                chaptersPreview.style.display = 'block';
            }

            splitChapters() {
                this.showProgress();
                const lines = this.fileContent.split('\n');
                const chapterFiles = [];

                this.chapters.forEach((chapter, index) => {
                    const startLine = chapter.index;
                    const endLine = index === this.chapters.length - 1 ? lines.length : this.chapters[index + 1].index;

                    const chapterLines = lines.slice(startLine, endLine);
                    const chapterContent = chapterLines.join('\n');

                    const safeTitle = chapter.title.replace(/[<>:"/\\|?*]/g, '_');
                    const filename = `${String(index + 1).padStart(2, '0')}_${safeTitle}.txt`;

                    chapterFiles.push({
                        filename: filename,
                        content: chapterContent,
                        title: chapter.title,
                        index: index
                    });

                    const progress = ((index + 1) / this.chapters.length) * 100;
                    this.updateProgress(progress);
                });

                this.chapterFiles = chapterFiles;
                this.hideProgress();
                this.showDownloadSection();
                this.showStatus(`æ‹†åˆ†å®Œæˆï¼å…±ç”Ÿæˆ ${this.chapters.length} ä¸ªç« èŠ‚æ–‡ä»¶`, 'success');
            }

            showProgress() {
                document.getElementById('progress').style.display = 'block';
                document.getElementById('splitBtn').disabled = true;
            }

            hideProgress() {
                document.getElementById('progress').style.display = 'none';
                document.getElementById('splitBtn').disabled = false;
            }

            updateProgress(percent) {
                document.getElementById('progressBar').style.width = percent + '%';
            }

            showDownloadSection() {
                const downloadSection = document.getElementById('downloadSection');
                const chapterCount = document.getElementById('chapterCount');
                
                chapterCount.textContent = this.chapters.length;
                downloadSection.style.display = 'block';
            }

            downloadAllChapters() {
                if (!this.chapterFiles) return;

                this.chapterFiles.forEach((file, index) => {
                    setTimeout(() => {
                        this.downloadFile(file.filename, file.content);
                    }, index * 100);
                });
            }

            downloadFile(filename, content) {
                const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            // æ ¼å¼ç›¸å…³æ–¹æ³•
            updateFormatHint() {
                const formatType = document.getElementById('formatType').value;
                const uploadHint = document.getElementById('uploadHint');
                
                if (formatType === 'markdown') {
                    uploadHint.textContent = 'æ”¯æŒ .txt æ–‡ä»¶ï¼ŒMarkdownæ ¼å¼ï¼š##æ­£æ–‡ + ###ç¬¬Xç« ';
                } else {
                    uploadHint.textContent = 'æ”¯æŒ .txt æ–‡ä»¶ï¼Œç« èŠ‚æ ¼å¼ï¼šç¬¬Xç«  æ ‡é¢˜';
                }
            }

            handleMergeFileSelect(event) {
                const files = Array.from(event.target.files);
                if (files.length > 0) {
                    this.processMergeFiles(files);
                }
            }

            async processMergeFiles(files) {
                this.mergeFiles = [];
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const content = await this.readFileAsText(file);
                    this.mergeFiles.push({
                        name: file.name,
                        content: content
                    });
                }

                // æŒ‰æ–‡ä»¶åæ’åº
                this.mergeFiles.sort((a, b) => a.name.localeCompare(b.name));
                this.showMergePreview();
            }

            readFileAsText(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => resolve(e.target.result);
                    reader.onerror = reject;
                    reader.readAsText(file, 'UTF-8');
                });
            }

            showMergePreview() {
                const mergeSection = document.getElementById('mergeSection');
                const mergePreview = document.getElementById('mergePreview');
                
                let previewContent = '';
                this.mergeFiles.forEach((file, index) => {
                    previewContent += `=== ${file.name} ===\n`;
                    previewContent += file.content.substring(0, 200) + (file.content.length > 200 ? '...' : '') + '\n\n';
                });
                
                mergePreview.textContent = previewContent;
                mergeSection.style.display = 'block';
                this.showMergeStatus(`å·²é€‰æ‹© ${this.mergeFiles.length} ä¸ªæ–‡ä»¶è¿›è¡Œåˆå¹¶`, 'info');
            }

            mergeChapters() {
                if (!this.mergeFiles || this.mergeFiles.length === 0) {
                    this.showMergeStatus('è¯·å…ˆé€‰æ‹©è¦åˆå¹¶çš„æ–‡ä»¶', 'error');
                    return;
                }

                const formatType = document.getElementById('formatType').value;
                let mergedContent = '';
                
                if (formatType === 'markdown') {
                    mergedContent = '##æ­£æ–‡';
                }
                
                this.mergeFiles.forEach((file, index) => {
                    mergedContent += file.content + '\n';
                });

                // ä¸‹è½½åˆå¹¶åçš„æ–‡ä»¶
                const blob = new Blob([mergedContent], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `åˆå¹¶åçš„æ–‡æ¡£_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                this.showMergeStatus('åˆå¹¶å®Œæˆï¼æ–‡ä»¶å·²ä¸‹è½½', 'success');
            }

            showMergeStatus(message, type) {
                const status = document.getElementById('mergeStatus');
                status.textContent = message;
                status.className = `status ${type}`;
                status.style.display = 'block';

                if (type === 'success') {
                    setTimeout(() => {
                        status.style.display = 'none';
                    }, 5000);
                }
            }

            // AIç›¸å…³æ–¹æ³•
            loadAIConfig() {
                const config = JSON.parse(localStorage.getItem('aiConfig') || '{}');
                if (config.provider) document.getElementById('aiProvider').value = config.provider;
                if (config.apiKey) document.getElementById('apiKey').value = config.apiKey;
                if (config.endpoint) document.getElementById('apiEndpoint').value = config.endpoint;
                if (config.model) document.getElementById('modelName').value = config.model;
                if (config.systemPrompt) document.getElementById('systemPrompt').value = config.systemPrompt;
                if (config.maxTokens) document.getElementById('maxTokens').value = config.maxTokens;
                if (config.temperature) {
                    document.getElementById('temperature').value = config.temperature;
                    document.getElementById('temperatureValue').textContent = config.temperature;
                }
                
                // æ ¹æ®æä¾›å•†è®¾ç½®é»˜è®¤é…ç½®
                this.updateProviderConfig();
            }

            updateProviderConfig() {
                const provider = document.getElementById('aiProvider').value;
                const endpointInput = document.getElementById('apiEndpoint');
                const modelInput = document.getElementById('modelName');
                
                console.log('ğŸ”§ æ›´æ–°æä¾›å•†é…ç½®:', provider);
                
                switch(provider) {
                    case 'openai':
                        endpointInput.value = 'https://api.openai.com/v1/chat/completions';
                        modelInput.value = 'gpt-3.5-turbo';
                        break;
                    case 'anthropic':
                        endpointInput.value = 'https://api.anthropic.com/v1/messages';
                        modelInput.value = 'claude-3-sonnet-20240229';
                        break;
                    case 'doubao':
                        endpointInput.value = 'https://ark.cn-beijing.volces.com/api/v3/chat/completions';
                        modelInput.value = 'doubao-1.5-pro-32k-250115';
                        console.log('âœ… è®¾ç½®è±†åŒ…æ¨¡å‹:', modelInput.value);
                        break;
                    case 'google':
                        endpointInput.value = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent';
                        modelInput.value = 'gemini-pro';
                        break;
                    case 'custom':
                        // ä¿æŒç”¨æˆ·è‡ªå®šä¹‰çš„å€¼
                        break;
                }
                
                console.log('ğŸ” é…ç½®æ›´æ–°å:');
                console.log('æ¨¡å‹åç§°:', modelInput.value);
                console.log('APIç«¯ç‚¹:', endpointInput.value);
            }

            saveAIConfig() {
                const config = {
                    provider: document.getElementById('aiProvider').value,
                    apiKey: document.getElementById('apiKey').value,
                    endpoint: document.getElementById('apiEndpoint').value,
                    model: document.getElementById('modelName').value,
                    systemPrompt: document.getElementById('systemPrompt').value,
                    maxTokens: parseInt(document.getElementById('maxTokens').value),
                    temperature: parseFloat(document.getElementById('temperature').value)
                };
                localStorage.setItem('aiConfig', JSON.stringify(config));
                this.showAIStatus('é…ç½®å·²ä¿å­˜', 'success');
            }

            async testAIConnection() {
                const config = this.getAIConfig();
                if (!config.apiKey) {
                    this.showAIStatus('è¯·å…ˆè¾“å…¥APIå¯†é’¥', 'error');
                    return;
                }

                this.showAIStatus('æ­£åœ¨æµ‹è¯•è¿æ¥...', 'info');
                
                try {
                    const response = await this.callAI('è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•æ¶ˆæ¯ï¼Œè¯·å›å¤"è¿æ¥æˆåŠŸ"', config);
                    this.showAIStatus('AIè¿æ¥æµ‹è¯•æˆåŠŸï¼\n\nAIå›å¤ï¼š' + response, 'success');
                } catch (error) {
                    this.showAIStatus('AIè¿æ¥æµ‹è¯•å¤±è´¥ï¼š\n\n' + error.message, 'error');
                }
            }

            async diagnoseConnection() {
                const config = this.getAIConfig();
                const diagnosticInfo = document.getElementById('diagnosticInfo');
                
                let diagnosticHTML = '<h4>ğŸ”§ è¿æ¥è¯Šæ–­ç»“æœ</h4>';
                
                // æ£€æŸ¥é…ç½®
                diagnosticHTML += '<div class="diagnostic-item">';
                if (!config.apiKey) {
                    diagnosticHTML += '<span class="diagnostic-error">âŒ APIå¯†é’¥æœªè®¾ç½®</span>';
                } else {
                    diagnosticHTML += `<span class="diagnostic-success">âœ… APIå¯†é’¥å·²è®¾ç½® (é•¿åº¦: ${config.apiKey.length})</span>`;
                }
                diagnosticHTML += '</div>';
                
                diagnosticHTML += '<div class="diagnostic-item">';
                if (!config.endpoint) {
                    diagnosticHTML += '<span class="diagnostic-error">âŒ APIç«¯ç‚¹æœªè®¾ç½®</span>';
                } else {
                    diagnosticHTML += `<span class="diagnostic-success">âœ… APIç«¯ç‚¹: ${config.endpoint}</span>`;
                }
                diagnosticHTML += '</div>';
                
                diagnosticHTML += '<div class="diagnostic-item">';
                if (!config.model) {
                    diagnosticHTML += '<span class="diagnostic-error">âŒ æ¨¡å‹åç§°æœªè®¾ç½®</span>';
                } else {
                    diagnosticHTML += `<span class="diagnostic-success">âœ… æ¨¡å‹åç§°: ${config.model}</span>`;
                }
                diagnosticHTML += '</div>';
                
                // æ£€æŸ¥APIå¯†é’¥æ ¼å¼
                diagnosticHTML += '<div class="diagnostic-item">';
                if (config.apiKey) {
                    if (config.apiKey.startsWith('sk-')) {
                        diagnosticHTML += '<span class="diagnostic-success">âœ… APIå¯†é’¥æ ¼å¼æ­£ç¡® (OpenAIæ ¼å¼)</span>';
                    } else if (config.apiKey.startsWith('claude-')) {
                        diagnosticHTML += '<span class="diagnostic-success">âœ… APIå¯†é’¥æ ¼å¼æ­£ç¡® (Anthropicæ ¼å¼)</span>';
                    } else if (config.apiKey.length === 36 && config.apiKey.includes('-')) {
                        diagnosticHTML += '<span class="diagnostic-success">âœ… APIå¯†é’¥æ ¼å¼æ­£ç¡® (è±†åŒ…æ¨¡å‹æ ¼å¼)</span>';
                    } else {
                        diagnosticHTML += '<span class="diagnostic-warning">âš ï¸ APIå¯†é’¥æ ¼å¼å¯èƒ½ä¸æ­£ç¡®</span>';
                    }
                }
                diagnosticHTML += '</div>';
                
                // ç½‘ç»œè¿æ¥æµ‹è¯•
                diagnosticHTML += '<div class="diagnostic-item">';
                try {
                    const endpoint = config.endpoint || 'https://api.openai.com/v1/chat/completions';
                    const url = new URL(endpoint);
                    const testResponse = await fetch(`https://${url.hostname}`, { 
                        method: 'HEAD',
                        mode: 'no-cors'
                    });
                    diagnosticHTML += '<span class="diagnostic-success">âœ… ç½‘ç»œè¿æ¥æ­£å¸¸</span>';
                } catch (error) {
                    diagnosticHTML += '<span class="diagnostic-error">âŒ ç½‘ç»œè¿æ¥å¤±è´¥</span>';
                }
                diagnosticHTML += '</div>';
                
                diagnosticInfo.innerHTML = diagnosticHTML;
                diagnosticInfo.style.display = 'block';
            }

            getAIConfig() {
                const config = {
                    provider: document.getElementById('aiProvider').value,
                    apiKey: document.getElementById('apiKey').value,
                    endpoint: document.getElementById('apiEndpoint').value,
                    model: document.getElementById('modelName').value,
                    systemPrompt: document.getElementById('systemPrompt').value,
                    maxTokens: parseInt(document.getElementById('maxTokens').value),
                    temperature: parseFloat(document.getElementById('temperature').value)
                };
                
                // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                console.log('ğŸ” è·å–AIé…ç½®:');
                console.log('æ¨¡å‹åç§°:', config.model);
                console.log('APIç«¯ç‚¹:', config.endpoint);
                console.log('æä¾›å•†:', config.provider);
                
                return config;
            }

            async callAI(content, config) {
                const messages = [];
                
                if (config.systemPrompt) {
                    messages.push({ role: 'system', content: config.systemPrompt });
                }
                
                messages.push({ role: 'user', content: content });

                const requestBody = {
                    model: config.model || 'gpt-3.5-turbo',
                    messages: messages,
                    max_tokens: config.maxTokens || 2000,
                    temperature: config.temperature || 0.7
                };

                const endpoint = config.endpoint || 'https://api.openai.com/v1/chat/completions';
                
                // æ·»åŠ è°ƒè¯•ä¿¡æ¯
                console.log('ğŸ” å‘é€è¯·æ±‚è¯¦æƒ…:');
                console.log('æ¨¡å‹åç§°:', requestBody.model);
                console.log('APIç«¯ç‚¹:', endpoint);
                console.log('è¯·æ±‚ä½“:', JSON.stringify(requestBody, null, 2));
                
                try {
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${config.apiKey}`
                        },
                        body: JSON.stringify(requestBody)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        let errorDetail = '';
                        
                        try {
                            const errorData = JSON.parse(errorText);
                            if (errorData.error) {
                                errorDetail = `é”™è¯¯ç±»å‹: ${errorData.error.type || 'æœªçŸ¥'}\né”™è¯¯ä¿¡æ¯: ${errorData.error.message || 'æœªçŸ¥é”™è¯¯'}`;
                                
                                // é’ˆå¯¹å¸¸è§é”™è¯¯æä¾›è§£å†³æ–¹æ¡ˆ
                                const errorType = errorData.error.type || '';
                                if (errorType.includes('invalid_api_key') || errorType.includes('authentication')) {
                                    errorDetail += '\n\nğŸ”‘ APIå¯†é’¥é—®é¢˜è§£å†³æ–¹æ¡ˆ:\n1. æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®\n2. ç¡®è®¤APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆ\n3. æ£€æŸ¥APIå¯†é’¥æƒé™\n4. ç¡®è®¤è´¦æˆ·ä½™é¢å……è¶³';
                                } else if (errorType.includes('quota') || errorType.includes('billing')) {
                                    errorDetail += '\n\nğŸ’° é…é¢é—®é¢˜è§£å†³æ–¹æ¡ˆ:\n1. æ£€æŸ¥è´¦æˆ·ä½™é¢\n2. ç¡®è®¤APIä½¿ç”¨é…é¢\n3. å‡çº§è´¦æˆ·æˆ–å……å€¼';
                                } else if (errorType.includes('rate_limit')) {
                                    errorDetail += '\n\nâ±ï¸ é¢‘ç‡é™åˆ¶è§£å†³æ–¹æ¡ˆ:\n1. å‡å°‘è¯·æ±‚é¢‘ç‡\n2. å¢åŠ è¯·æ±‚é—´éš”\n3. ä½¿ç”¨æ‰¹å¤„ç†æ¨¡å¼';
                                } else if (errorType.includes('model') || errorType.includes('NotFound')) {
                                    errorDetail += '\n\nğŸ¤– æ¨¡å‹é—®é¢˜è§£å†³æ–¹æ¡ˆ:\n1. æ£€æŸ¥æ¨¡å‹åç§°æ˜¯å¦æ­£ç¡®\n2. ç¡®è®¤æ¨¡å‹æ˜¯å¦å¯ç”¨\n3. å°è¯•ä½¿ç”¨å…¶ä»–æ¨¡å‹\n4. æ£€æŸ¥æ¨¡å‹è®¿é—®æƒé™';
                                }
                            } else {
                                errorDetail = errorText;
                            }
                        } catch {
                            errorDetail = errorText;
                        }
                        
                        throw new Error(`APIè¯·æ±‚å¤±è´¥ (${response.status}):\n${errorDetail}`);
                    }

                    const data = await response.json();
                    return data.choices[0].message.content;
                    
                } catch (error) {
                    if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                        throw new Error(`ç½‘ç»œè¿æ¥é”™è¯¯:\n\nå¯èƒ½çš„åŸå› :\n1. ç½‘ç»œè¿æ¥ä¸ç¨³å®š\n2. APIç«¯ç‚¹åœ°å€é”™è¯¯\n3. é˜²ç«å¢™æˆ–ä»£ç†é˜»æ­¢è¿æ¥\n4. DNSè§£æå¤±è´¥\n\nå»ºè®®è§£å†³æ–¹æ¡ˆ:\n1. æ£€æŸ¥ç½‘ç»œè¿æ¥\n2. éªŒè¯APIç«¯ç‚¹åœ°å€æ˜¯å¦æ­£ç¡®\n3. å°è¯•ä½¿ç”¨VPNæˆ–æ›´æ¢ç½‘ç»œ\n4. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®`);
                    } else if (error.name === 'TypeError' && error.message.includes('timeout')) {
                        throw new Error(`è¯·æ±‚è¶…æ—¶:\n\nå¯èƒ½çš„åŸå› :\n1. ç½‘ç»œé€Ÿåº¦è¿‡æ…¢\n2. APIæœåŠ¡å™¨å“åº”æ…¢\n3. è¯·æ±‚å†…å®¹è¿‡å¤§\n\nå»ºè®®è§£å†³æ–¹æ¡ˆ:\n1. æ£€æŸ¥ç½‘ç»œé€Ÿåº¦\n2. å‡å°‘è¯·æ±‚å†…å®¹é•¿åº¦\n3. ç¨åé‡è¯•`);
                    } else {
                        throw new Error(`è¯·æ±‚å¼‚å¸¸:\n\né”™è¯¯ä¿¡æ¯: ${error.message}\n\nå»ºè®®è§£å†³æ–¹æ¡ˆ:\n1. æ£€æŸ¥ç½‘ç»œè¿æ¥\n2. éªŒè¯APIé…ç½®\n3. æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯`);
                    }
                }
            }

            async startBatchProcessing() {
                if (!this.chapterFiles || this.chapterFiles.length === 0) {
                    this.showProcessingStatus('è¯·å…ˆæ‹†åˆ†ç« èŠ‚', 'error');
                    return;
                }

                const config = this.getAIConfig();
                if (!config.apiKey) {
                    this.showProcessingStatus('è¯·å…ˆé…ç½®APIå¯†é’¥', 'error');
                    return;
                }

                this.isProcessing = true;
                this.currentBatch = 0;
                this.totalBatches = this.chapterFiles.length * 2; // ä¸¤è½®å¤„ç†
                this.aiResults = [];
                this.firstRoundResults = [];
                this.secondRoundResults = [];

                document.getElementById('startProcessing').style.display = 'none';
                document.getElementById('stopProcessing').style.display = 'inline-block';
                document.getElementById('processingProgress').style.display = 'block';

                this.showProcessingStatus('å¼€å§‹ç¬¬ä¸€è½®æ‰¹é‡å¤„ç†...', 'info');

                // ç¬¬ä¸€è½®å¤„ç†
                for (let i = 0; i < this.chapterFiles.length && this.isProcessing; i++) {
                    const chapter = this.chapterFiles[i];
                    this.currentBatch = i + 1;
                    
                    this.updateProcessingProgress((this.currentBatch / this.totalBatches) * 100);
                    this.showProcessingStatus(`ç¬¬ä¸€è½® - æ­£åœ¨å¤„ç†ç¬¬ ${this.currentBatch} ä¸ªç« èŠ‚: ${chapter.title}`, 'info');

                    try {
                        const result = await this.callAI(chapter.content, config);
                        this.firstRoundResults.push({
                            chapter: chapter,
                            result: result,
                            status: 'success',
                            timestamp: new Date().toLocaleString()
                        });
                    } catch (error) {
                        this.firstRoundResults.push({
                            chapter: chapter,
                            result: 'å¤„ç†å¤±è´¥: ' + error.message,
                            status: 'error',
                            timestamp: new Date().toLocaleString()
                        });
                    }

                    // æ‰¹æ¬¡é—´éš”
                    if (i < this.chapterFiles.length - 1 && this.isProcessing) {
                        const delay = parseInt(document.getElementById('delayBetweenBatches').value) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }

                if (!this.isProcessing) {
                    this.stopBatchProcessing();
                    return;
                }

                // ç¬¬äºŒè½®å¤„ç†
                this.showProcessingStatus('å¼€å§‹ç¬¬äºŒè½®æ‰¹é‡å¤„ç†...', 'info');
                
                for (let i = 0; i < this.chapterFiles.length && this.isProcessing; i++) {
                    const chapter = this.chapterFiles[i];
                    this.currentBatch = this.chapterFiles.length + i + 1;
                    
                    this.updateProcessingProgress((this.currentBatch / this.totalBatches) * 100);
                    this.showProcessingStatus(`ç¬¬äºŒè½® - æ­£åœ¨å¤„ç†ç¬¬ ${i + 1} ä¸ªç« èŠ‚: ${chapter.title}`, 'info');

                    try {
                        const result = await this.callAI(chapter.content, config);
                        this.secondRoundResults.push({
                            chapter: chapter,
                            result: result,
                            status: 'success',
                            timestamp: new Date().toLocaleString()
                        });
                    } catch (error) {
                        this.secondRoundResults.push({
                            chapter: chapter,
                            result: 'å¤„ç†å¤±è´¥: ' + error.message,
                            status: 'error',
                            timestamp: new Date().toLocaleString()
                        });
                    }

                    // æ‰¹æ¬¡é—´éš”
                    if (i < this.chapterFiles.length - 1 && this.isProcessing) {
                        const delay = parseInt(document.getElementById('delayBetweenBatches').value) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }

                this.isProcessing = false;
                document.getElementById('startProcessing').style.display = 'inline-block';
                document.getElementById('stopProcessing').style.display = 'none';
                
                this.showProcessingStatus('åŒè½®å¤„ç†å®Œæˆï¼æ­£åœ¨åˆ†æå·®å¼‚...', 'success');
                this.analyzeDifferences();
                this.displayAIResults();
                switchTab('results');
            }

            stopBatchProcessing() {
                this.isProcessing = false;
                this.showProcessingStatus('å¤„ç†å·²åœæ­¢', 'warning');
                document.getElementById('startProcessing').style.display = 'inline-block';
                document.getElementById('stopProcessing').style.display = 'none';
            }

            updateProcessingProgress(percent) {
                document.getElementById('processingProgressBar').style.width = percent + '%';
            }

            displayAIResults() {
                const resultsContainer = document.getElementById('aiResults');
                const resultsList = document.getElementById('aiResultsList');
                
                resultsList.innerHTML = '';
                
                this.aiResults.forEach((result, index) => {
                    const resultItem = document.createElement('div');
                    resultItem.className = 'ai-result-item';
                    
                    let statusText = result.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥';
                    let statusClass = result.status;
                    
                    if (result.status === 'success') {
                        if (result.hasDifferences) {
                            statusText = 'æœ‰å·®å¼‚';
                            statusClass = 'warning';
                        } else {
                            statusText = 'æ— å·®å¼‚';
                            statusClass = 'success';
                        }
                    }
                    
                    let contentHtml = '';
                    
                    if (result.status === 'error') {
                        contentHtml = `
                            <div class="error-content">
                                <p><strong>ç¬¬ä¸€è½®ç»“æœ:</strong></p>
                                <pre>${result.firstResult}</pre>
                                <p><strong>ç¬¬äºŒè½®ç»“æœ:</strong></p>
                                <pre>${result.secondResult}</pre>
                            </div>
                        `;
                    } else if (result.hasDifferences) {
                        // æ˜¾ç¤ºå·®å¼‚å¯¹æ¯”
                        contentHtml = `
                            <div class="differences-container">
                                <div class="differences-header">
                                    <h4>ğŸ” å‘ç° ${result.differences.length} å¤„å·®å¼‚</h4>
                                    <div class="selection-buttons">
                                        <button class="btn btn-sm btn-primary" onclick="selectResult(${index}, 'first')" ${result.selectedResult === 'first' ? 'disabled' : ''}>
                                            âœ… é€‰æ‹©ç¬¬ä¸€è½®ç»“æœ
                                        </button>
                                        <button class="btn btn-sm btn-secondary" onclick="selectResult(${index}, 'second')" ${result.selectedResult === 'second' ? 'disabled' : ''}>
                                            âœ… é€‰æ‹©ç¬¬äºŒè½®ç»“æœ
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="differences-list">
                                    ${result.differences.map(diff => `
                                        <div class="difference-item">
                                            <div class="difference-line">ç¬¬ ${diff.lineNumber} è¡Œ:</div>
                                            <div class="difference-content">
                                                <div class="first-version">
                                                    <span class="version-label">ç¬¬ä¸€è½®:</span>
                                                    <pre>${diff.firstLine}</pre>
                                                </div>
                                                <div class="second-version">
                                                    <span class="version-label">ç¬¬äºŒè½®:</span>
                                                    <pre>${diff.secondLine}</pre>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <div class="full-results">
                                    <details>
                                        <summary>ğŸ“„ æŸ¥çœ‹å®Œæ•´ç»“æœ</summary>
                                        <div class="full-results-content">
                                            <div class="result-version">
                                                <h5>ç¬¬ä¸€è½®å®Œæ•´ç»“æœ:</h5>
                                                <pre>${result.firstResult}</pre>
                                            </div>
                                            <div class="result-version">
                                                <h5>ç¬¬äºŒè½®å®Œæ•´ç»“æœ:</h5>
                                                <pre>${result.secondResult}</pre>
                                            </div>
                                        </div>
                                    </details>
                                </div>
                            </div>
                        `;
                    } else {
                        // æ— å·®å¼‚ï¼Œæ˜¾ç¤ºé»˜è®¤ç»“æœ
                        contentHtml = `
                            <div class="no-differences">
                                <p>âœ… ä¸¤è½®å¤„ç†ç»“æœå®Œå…¨ä¸€è‡´ï¼Œæ— éœ€é€‰æ‹©</p>
                                <details>
                                    <summary>ğŸ“„ æŸ¥çœ‹å¤„ç†ç»“æœ</summary>
                                    <pre>${result.firstResult}</pre>
                                </details>
                            </div>
                        `;
                    }
                    
                    resultItem.innerHTML = `
                        <div class="ai-result-header">
                            <span class="ai-result-title">${result.chapter.title}</span>
                            <span class="ai-result-status ${statusClass}">${statusText}</span>
                        </div>
                        ${contentHtml}
                        <small style="color: #666; margin-top: 10px; display: block;">å¤„ç†æ—¶é—´: ${result.timestamp}</small>
                    `;
                    resultsList.appendChild(resultItem);
                });
                
                resultsContainer.style.display = 'block';
                document.getElementById('downloadResults').style.display = 'inline-block';
            }

            selectResult(index, round) {
                if (this.aiResults[index]) {
                    this.aiResults[index].selectedResult = round;
                    this.displayAIResults(); // é‡æ–°æ˜¾ç¤ºä»¥æ›´æ–°æŒ‰é’®çŠ¶æ€
                }
            }

            downloadAllResults() {
                if (!this.aiResults || this.aiResults.length === 0) return;

                // åœ¨å¼€å¤´æ·»åŠ ##æ­£æ–‡ï¼Œæ·»åŠ ä¸€ä¸ªç©ºè¡Œ
                let resultsText = '##æ­£æ–‡\n';
                
                // æ ¹æ®ç”¨æˆ·é€‰æ‹©ä¸‹è½½ç»“æœ
                this.aiResults.forEach((result, index) => {
                    let contentToUse = '';
                    // å¤„ç†å¤±è´¥é€»è¾‘
                    const firstFailed = result.firstResult && result.firstResult.startsWith('å¤„ç†å¤±è´¥');
                    const secondFailed = result.secondResult && result.secondResult.startsWith('å¤„ç†å¤±è´¥');
                    if (firstFailed && !secondFailed) {
                        contentToUse = result.secondResult;
                    } else if (!firstFailed && secondFailed) {
                        contentToUse = result.firstResult;
                    } else if (firstFailed && secondFailed) {
                        contentToUse = `ã€ä¸¤è½®AIå¤„ç†å‡å¤±è´¥ï¼Œè¯·é‡æ–°ç”Ÿæˆæœ¬ç« èŠ‚å†…å®¹ã€‘`;
                    } else if (result.selectedResult === 'second') {
                        contentToUse = result.secondResult;
                    } else {
                        contentToUse = result.firstResult;
                    }
                    // å»é™¤æ˜Ÿå·å¹¶æ·»åŠ AIç”Ÿæˆçš„å†…å®¹
                    let cleanContent = contentToUse.replace(/\*\*/g, '');
                    resultsText += cleanContent + '\n\n';
                });

                const blob = new Blob([resultsText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `AIåŒå¤„ç†ç»“æœ_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            clearResults() {
                this.aiResults = [];
                this.firstRoundResults = [];
                this.secondRoundResults = [];
                document.getElementById('aiResultsList').innerHTML = '';
                document.getElementById('aiResults').style.display = 'none';
                document.getElementById('downloadResults').style.display = 'none';
            }

            showStatus(message, type) {
                const status = document.getElementById('status');
                status.textContent = message;
                status.className = `status ${type}`;
                status.style.display = 'block';

                if (type === 'success') {
                    setTimeout(() => {
                        status.style.display = 'none';
                    }, 5000);
                }
            }

            showAIStatus(message, type) {
                const status = document.getElementById('aiStatus');
                status.textContent = message;
                status.className = `status ${type}`;
                status.style.display = 'block';

                if (type === 'success') {
                    setTimeout(() => {
                        status.style.display = 'none';
                    }, 5000);
                }
            }

            showProcessingStatus(message, type) {
                const status = document.getElementById('processingStatus');
                status.textContent = message;
                status.className = `status ${type}`;
                status.style.display = 'block';
            }

            analyzeDifferences() {
                this.aiResults = [];
                
                for (let i = 0; i < this.firstRoundResults.length; i++) {
                    const firstResult = this.firstRoundResults[i];
                    const secondResult = this.secondRoundResults[i];
                    
                    if (firstResult.status === 'error' || secondResult.status === 'error') {
                        // å¦‚æœä»»ä¸€è½®å¤„ç†å¤±è´¥ï¼Œæ ‡è®°ä¸ºé”™è¯¯
                        this.aiResults.push({
                            chapter: firstResult.chapter,
                            firstResult: firstResult.result,
                            secondResult: secondResult.result,
                            status: 'error',
                            hasDifferences: false,
                            differences: [],
                            selectedResult: 'first', // é»˜è®¤é€‰æ‹©ç¬¬ä¸€è½®
                            timestamp: new Date().toLocaleString()
                        });
                        continue;
                    }
                    
                    // åˆ†æå·®å¼‚
                    const differences = this.findDifferences(firstResult.result, secondResult.result);
                    const hasDifferences = differences.length > 0;
                    
                    this.aiResults.push({
                        chapter: firstResult.chapter,
                        firstResult: firstResult.result,
                        secondResult: secondResult.result,
                        status: 'success',
                        hasDifferences: hasDifferences,
                        differences: differences,
                        selectedResult: hasDifferences ? null : 'first', // æ— å·®å¼‚æ—¶é»˜è®¤é€‰æ‹©ç¬¬ä¸€è½®
                        timestamp: new Date().toLocaleString()
                    });
                }
            }

            findDifferences(text1, text2) {
                const differences = [];
                
                // ç®€å•çš„é€è¡Œå¯¹æ¯”
                const lines1 = text1.split('\n');
                const lines2 = text2.split('\n');
                
                const maxLines = Math.max(lines1.length, lines2.length);
                
                for (let i = 0; i < maxLines; i++) {
                    const line1 = lines1[i] || '';
                    const line2 = lines2[i] || '';
                    
                    if (line1.trim() !== line2.trim()) {
                        differences.push({
                            lineNumber: i + 1,
                            firstLine: line1,
                            secondLine: line2
                        });
                    }
                }
                
                return differences;
            }
        }

        // å…¨å±€å‡½æ•°
        let splitter;

        function switchTab(tabName) {
            // éšè—æ‰€æœ‰æ ‡ç­¾é¡µå†…å®¹
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeç±»
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„æ ‡ç­¾é¡µ
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // æ¿€æ´»å¯¹åº”çš„æ ‡ç­¾
            event.target.classList.add('active');
        }

        function testAIConnection() {
            splitter.testAIConnection();
        }

        function saveAIConfig() {
            splitter.saveAIConfig();
        }

        function diagnoseConnection() {
            splitter.diagnoseConnection();
        }

        function startBatchProcessing() {
            splitter.startBatchProcessing();
        }

        function stopBatchProcessing() {
            splitter.stopBatchProcessing();
        }

        function downloadAllResults() {
            splitter.downloadAllResults();
        }

        function clearResults() {
            splitter.clearResults();
        }

        function selectResult(index, round) {
            splitter.selectResult(index, round);
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            splitter = new AIChapterSplitter();
        });
    </script>
</body>
</html> 